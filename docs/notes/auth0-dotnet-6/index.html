<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Teng Wei Song | Notes | Authentication and Authorisation with Auth0 and .NET 6</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" name="format-detection" content="telephone=no"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon.png"><link data-n-head="ssr" rel="apple-touch-icon" type="image/png" href="/favicon.png"><link rel="preload" href="/_nuxt/d235ded.js" as="script"><link rel="preload" href="/_nuxt/c37e852.js" as="script"><link rel="preload" href="/_nuxt/028b3bc.js" as="script"><link rel="preload" href="/_nuxt/93a70bb.js" as="script"><link rel="preload" href="/_nuxt/9e8d9e6.js" as="script"><style data-vue-ssr-id="d706d280:0 d706d280:1 d706d280:2 15f0552d:0 3354e033:0 bb038ae2:0 6755eee4:0">@import url(https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;1,300;1,500&display=swap);@import url(https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+Antique&display=swap);/*! tailwindcss v2.2.19 | MIT License | https://tailwindcss.com*//*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}html{-moz-tab-size:4;-o-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:Zen Kaku Gothic Antique,sans-serif;line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:currentColor}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}*,::after,::before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}body{--tw-bg-opacity:1;background-color:rgba(243,244,246,var(--tw-bg-opacity))}main{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}::-moz-selection{--tw-bg-opacity:1;background-color:rgba(156,163,175,var(--tw-bg-opacity));--tw-text-opacity:1;color:rgba(243,244,246,var(--tw-text-opacity))}::selection{--tw-bg-opacity:1;background-color:rgba(156,163,175,var(--tw-bg-opacity));--tw-text-opacity:1;color:rgba(243,244,246,var(--tw-text-opacity))}.static{position:static}.mx-4{margin-left:1rem;margin-right:1rem}.mx-auto{margin-left:auto;margin-right:auto}.my-1{margin-top:.25rem;margin-bottom:.25rem}.my-4{margin-top:1rem;margin-bottom:1rem}.my-6{margin-top:1.5rem;margin-bottom:1.5rem}.my-8{margin-top:2rem;margin-bottom:2rem}.my-12{margin-top:3rem;margin-bottom:3rem}.mt-4{margin-top:1rem}.mt-24{margin-top:6rem}.mb-auto{margin-bottom:auto}.ml-1{margin-left:.25rem}.flex{display:flex}.table{display:table}.grid{display:grid}.h-3{height:.75rem}.h-4{height:1rem}.h-6{height:1.5rem}.h-10{height:2.5rem}.h-12{height:3rem}.h-48{height:12rem}.h-screen{height:100vh}.w-2{width:.5rem}.w-screen{width:100vw}.w-min{width:-webkit-min-content;width:-moz-min-content;width:min-content}.max-w-4xl{max-width:56rem}@-webkit-keyframes spin{to{transform:rotate(360deg)}}@keyframes spin{to{transform:rotate(360deg)}}@-webkit-keyframes ping{100%,75%{transform:scale(2);opacity:0}}@keyframes ping{100%,75%{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,100%{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,100%{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}.list-disc{list-style-type:disc}.list-decimal{list-style-type:decimal}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.flex-row{flex-direction:row}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-center{justify-content:center}.justify-items-center{justify-items:center}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-4{gap:1rem}.space-x-1>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(.25rem * var(--tw-space-x-reverse));margin-left:calc(.25rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-8>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(2rem * var(--tw-space-x-reverse));margin-left:calc(2rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.border{border-width:1px}.border-t{border-top-width:1px}.border-b-2{border-bottom-width:2px}.border-gray-200{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.border-gray-400{--tw-border-opacity:1;border-color:rgba(156,163,175,var(--tw-border-opacity))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgba(156,163,175,var(--tw-bg-opacity))}.bg-yellow-100{--tw-bg-opacity:1;background-color:rgba(254,243,199,var(--tw-bg-opacity))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity))}.object-cover{-o-object-fit:cover;object-fit:cover}.p-1{padding:.25rem}.p-2{padding:.5rem}.px-1{padding-left:.25rem;padding-right:.25rem}.pt-1{padding-top:.25rem}.pt-2{padding-top:.5rem}.text-center{text-align:center}.text-justify{text-align:justify}.align-middle{vertical-align:middle}.font-sans{font-family:Zen Kaku Gothic Antique,sans-serif}.font-serif{font-family:"Crimson Pro",serif}.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-6xl{font-size:3.75rem;line-height:1}.font-normal{font-weight:400}.font-bold{font-weight:700}.text-gray-100{--tw-text-opacity:1;color:rgba(243,244,246,var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.hover\:text-gray-800:hover{--tw-text-opacity:1;color:rgba(31,41,55,var(--tw-text-opacity))}.underline{text-decoration:underline}*,::after,::before{--tw-shadow:0 0 #0000}*,::after,::before{--tw-ring-inset:var(--tw-empty, );/*!*//*!*/--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59, 130, 246, 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}.filter{--tw-blur:var(--tw-empty, );/*!*//*!*/--tw-brightness:var(--tw-empty, );/*!*//*!*/--tw-contrast:var(--tw-empty, );/*!*//*!*/--tw-grayscale:var(--tw-empty, );/*!*//*!*/--tw-hue-rotate:var(--tw-empty, );/*!*//*!*/--tw-invert:var(--tw-empty, );/*!*//*!*/--tw-saturate:var(--tw-empty, );/*!*//*!*/--tw-sepia:var(--tw-empty, );/*!*//*!*/--tw-drop-shadow:var(--tw-empty, );/*!*//*!*/filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.grayscale{--tw-grayscale:grayscale(100%)}.saturate-50{--tw-saturate:saturate(.5)}@media (min-width:640px){.sm\:h-6{height:1.5rem}.sm\:h-14{height:3.5rem}.sm\:h-16{height:4rem}.sm\:h-80{height:20rem}.sm\:w-1\/4{width:25%}.sm\:w-3\/4{width:75%}.sm\:flex-row{flex-direction:row}.sm\:gap-6{gap:1.5rem}.sm\:space-x-16>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(4rem * var(--tw-space-x-reverse));margin-left:calc(4rem * calc(1 - var(--tw-space-x-reverse)))}}code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.nuxt-link-exact-active[data-v-8446ca32]{border-bottom-width:2px;--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}.nuxt-content>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.nuxt-content{text-align:justify}.nuxt-content h1{padding-top:.5rem;font-size:1.5rem;line-height:2rem;font-weight:700}.nuxt-content h2{padding-top:.25rem;font-size:1.25rem;line-height:1.75rem;font-weight:700}.nuxt-content h3{font-size:1.125rem;line-height:1.75rem;font-weight:700}.nuxt-content a{text-decoration:underline}.nuxt-content a:hover{text-decoration:none}.nuxt-content ol{list-style-position:inside;list-style-type:decimal}.nuxt-content ul{list-style-position:inside;list-style-type:disc}</style><link rel="preload" href="/_nuxt/static/1663072908/notes/auth0-dotnet-6/state.js" as="script"><link rel="preload" href="/_nuxt/static/1663072908/notes/auth0-dotnet-6/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1663072908/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><main class="h-screen w-screen max-w-4xl my-4 mx-auto font-serif"><div class="flex flex-col mx-4 gap-4"><nav class="my-8" data-v-8446ca32><ul class="flex flex-row sm:space-x-16 space-x-4 items-center justify-center" data-v-8446ca32><li data-v-8446ca32><a href="/" class="p-2 hover:bg-gray-200 nuxt-link-active" data-v-8446ca32>Home</a></li><li data-v-8446ca32><a href="/about-me" class="p-2 hover:bg-gray-200" data-v-8446ca32>About Me</a></li><li data-v-8446ca32><a href="/projects" class="p-2 hover:bg-gray-200" data-v-8446ca32>Projects</a></li><li data-v-8446ca32><a href="/notes" class="p-2 hover:bg-gray-200 nuxt-link-active" data-v-8446ca32>Notes</a></li></ul></nav> <div class="my-8 mb-auto"><div><div class="mt-4"><a href="/notes" class="border border-gray-200 font-sans text-gray-400 text-xs p-1 hover:bg-gray-200 nuxt-link-active">back to Notes</a></div> <br> <h1 class="text-3xl font-normal text-center">Authentication and Authorisation with Auth0 and .NET 6</h1> <p class="text-gray-500 text-sm text-center">How to protect .NET 6 API resources by implementing access control using Auth0</p> <br> <p class="text-xs font-sans my-1 text-center"><span class="border border-gray-400 px-1 ml-1 text-gray-400">.NET</span><span class="border border-gray-400 px-1 ml-1 text-gray-400">Auth0</span><span class="border border-gray-400 px-1 ml-1 text-gray-400">Authentication</span><span class="border border-gray-400 px-1 ml-1 text-gray-400">Authorisation</span></p> <p class="text-gray-500 text-sm text-center">
        Published at 31st Jul 2022 7:16 pm
      </p> <p class="text-gray-500 text-sm text-center">
        Last updated at 13th Sep 2022 8:26 pm
      </p> <br> <div class="nuxt-content"><p>For web applications built with .NET, the default choice for authentication and authorisation that comes to our minds would be Identity Server which will be deprecated after November 2022. An alternative is to make use of established SAAS like Auth0. This saves us a lot of time and effort from security patching and maintenance.</p>
<h1 id="getting-started"><a aria-hidden="true" href="#getting-started" tabindex="-1"><span class="icon icon-link"></span></a>Getting Started</h1>
<p>After signing up an account with Auth0 and created a tenant, we have to first create a client application on the dashboard. It represents the client or user agent (for example a React.js frontend application). Next we have to create an API on the dashboard as well. This will represent the .NET 6 resources. The RBAC has to be enabled and permissions have to be added to the token.</p>
<h1 id="authentication"><a aria-hidden="true" href="#authentication" tabindex="-1"><span class="icon icon-link"></span></a>Authentication</h1>
<p>Since we will be using the authorisation code flow, the first thing we need is to redirect the user to the Auth0 login page. The URL is usually</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-text"><code>https://{{domain}}/authorize?audience={{the API identifier}}&scope=openid&response_type=code&client_id=s{{Client ID}}&redirect_uri={{Callback URL}}
</code></pre></div>
<p>After successful sign in (or sign up), Auth0 will redirect the user back to the callback page. At this step the callback page can execute another API call to get the access token for subsequent API calls to the resources:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-bash"><code><span class="token function">curl</span> --location --request POST <span class="token string">'https://{{domain}}'</span> <span class="token punctuation">\</span>
--header <span class="token string">'Content-Type: application/x-www-form-urlencoded'</span> <span class="token punctuation">\</span>
--data-urlencode <span class="token string">'code={{the code we receive from callback page}}'</span> <span class="token punctuation">\</span>
--data-urlencode <span class="token string">'grant_type=authorization_code'</span> <span class="token punctuation">\</span>
--data-urlencode <span class="token string">'client_id={{Client ID}}'</span> <span class="token punctuation">\</span>
--data-urlencode <span class="token string">'redirect_uri={{Callback URL}}'</span>
</code></pre></div>
<p>Now we have the access token that we can pass to subsequent API calls to the .NET 6 resources by adding it to the “Authorisation” header. To implement authentication, add the following code to Program.cs:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span> <span class="token comment">//install this package if it is not in the project</span>
builder<span class="token punctuation">.</span>Services
  <span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>configureOptions <span class="token operator">=></span>
  <span class="token punctuation">{</span>
    configureOptions<span class="token punctuation">.</span>DefaultAuthenticateScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
    configureOptions<span class="token punctuation">.</span>DefaultChallengeScheme <span class="token operator">=</span>  JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>configureOptions <span class="token operator">=></span>
  <span class="token punctuation">{</span>
    configureOptions<span class="token punctuation">.</span>Authority <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>Auth0 domain<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    configureOptions<span class="token punctuation">.</span>Audience <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>the API identifier<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    configureOptions<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>TokenValidationParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      NameClaimType <span class="token operator">=</span> ClaimTypes<span class="token punctuation">.</span>NameIdentifier
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//... other code here</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>and to protect any controller:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
  <span class="token comment">//... your other code here</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h1 id="authorisation"><a aria-hidden="true" href="#authorisation" tabindex="-1"><span class="icon icon-link"></span></a>Authorisation</h1>
<p>Authorisation tells the API resources what a user can or cannot do. We can add permission information to a user on Auth0. First, add a custom permission named “read” in the “Permissions” tab in the API resource that we created earlier. Then, add the permission to the a user under the “User Management” page.
After this is completed, we can make a call to get a new access token for this user again. The permission will be included in the payload of the access token now (because we have enabled RBAC in previous step).
This permission information can then be used in .NET to check if an API request is authorised to be carried out. To consume the access token, add the following code to <code>Program.cs</code>:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-csharp"><code>builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>configure <span class="token operator">=></span>
<span class="token punctuation">{</span>
  configure<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span> policy <span class="token operator">=></span> policy<span class="token punctuation">.</span>Requirements<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">HasPermissionRequirement</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"{{Auth0 domain}}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//... other code here</span>
<span class="token comment">//after app.UseAuthentication();</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>At the same time, add a permission handler and a permission requirement to the code:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HasPermissionHandler</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>HasPermissionRequirement<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span> <span class="token class-name">HasPermissionRequirement</span> requirement<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">FindFirst</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>NameIdentifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">HasClaim</span><span class="token punctuation">(</span>c <span class="token operator">=></span> c<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">HasClaim</span><span class="token punctuation">(</span>c <span class="token operator">=></span> c<span class="token punctuation">.</span>Issuer <span class="token operator">==</span> requirement<span class="token punctuation">.</span>Issuer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> permissions <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">FindAll</span><span class="token punctuation">(</span>c <span class="token operator">=></span> c<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"permissions"</span> <span class="token operator">&&</span> c<span class="token punctuation">.</span>Issuer <span class="token operator">==</span> requirement<span class="token punctuation">.</span>Issuer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>c <span class="token operator">=></span> c<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">permissions</span><span class="token punctuation">(</span>s <span class="token operator">=></span> s <span class="token operator">==</span> requirement<span class="token punctuation">.</span>Permission<span class="token punctuation">)</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HasPermissionRequirement</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAuthorizationRequirement</span></span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Issuer <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Permission <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">HasPermissionRequirement</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> permission<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> issuer<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Permission <span class="token operator">=</span> permission <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Issuer <span class="token operator">=</span> issuer <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>issuer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>And finally to use the Authorisation in any controller:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
  <span class="token comment">//... your other code here</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>From now on, any API call with access token that does not have “read” in the permissions field will not be able to access this controller.</p></div> <br> <div class="border-t border-gray-400 text-gray-400 text-sm"><div class="flex flex-row gap-1"><span class="w-2 my-1 bg-gray-400"></span> <span>End</span></div></div> <br></div></div> <footer class="mt-24 text-sm text-gray-500 align-middle"><div class="grid space-x-4 justify-items-center"><div class="flex space-x-1 items-center"><a href="/" class="nuxt-link-active"><img src="/_nuxt/img/favicon.8555124.png" alt="personal-website" title="Personal Website" class="h-4"></a> <p><span>Personal Website</span></p></div> <div class="text-center my-6"><p>Connect with me through:</p> <ul class="flex space-x-4"><li title="Checkout my LinkedIn profile" class="flex items-center space-x-1"><span><img src="/_nuxt/img/linkedin.58f4a0d.png" alt="linkedin" class="h-3"></span> <span><a target="_blank" href="https://www.linkedin.com/in/tengweisong" class="hover:text-gray-800">LinkedIn</a></span></li> <li title="Explore my posts on Medium" class="flex items-center space-x-1"><span><img src="/_nuxt/img/medium.acdffa2.png" alt="medium" class="h-3"></span> <span><a target="_blank" href="https://weisong0908.medium.com" class="hover:text-gray-800">Medium</a></span></li> <li title="Some of my repositories on Github" class="flex items-center space-x-1"><span><img src="/_nuxt/img/github.b039b2d.png" alt="github" class="h-3"></span> <span><a target="_blank" href="https://github.com/weisong0908" class="hover:text-gray-800">Github</a></span></li> <li title="Email me" class="flex items-center space-x-1"><span><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAB2AAAAdgB+lymcgAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAI6SURBVHic7dq/ahRRHMXxz65BXQ0BGwsLbdQHsBCECDbpBG1EwV5bwZewt4oPoCE+iopiIkaiEAstrVxQE6PFzupkmclukrlzZzP3Cz9Y9k84v3MO7Ez2kkgkEolEoq10co+P4z5u4zxmoigKxxY+YgmL+Jl/8RxW8acls5LtDHp41wBRdc8qekfwAHe1j9P41sErXIosJhYvO/iOk7GVRKLfxa/YKiLyo4vXsVVE5E3X4DuxrfzbfVn8r6W6ZynvxAweY7sBwkLPdrZr4ZXuVaw3QGSo2cBC0eJ5TuARfjdAcJWpL2KuaOH5EiMOSxs2lKc+L+dO0cXQNLdht9R72V5bch/4hGslTk1bGzaUp34Fa7n3Fro2rW2YNPX8Zwr/0G5tWMDnBiw7Ol9wvUTzaOpjDRjXhrnstaZcNyzjVIHOstQnMmAa2rDf1PdkQFPbcJDU92xAk9pQRer7NiB2G6pK/UAGxGhD1alXYkBdbQiRemUGhGxDyNQrN6DqNoROPYgBVbShrtSDGjCuDbN4mC2zmc1a9txswftDpB7cgEnaAEezKSNU6rUZMK4NZYROvVYDhrOOG3b+JD9KBzfV+L+HztCFGvmA53iBr9lzZ3AZt3CxTjExDGgU3dgCYpMMiC0gNsmA2AJikwyILSA2yQD0Y4uISL9rcLfVVt538Sy2iog8ZXDr2aZzwsN5a3BAHIODwysNEFXn8mfZeW9+DPdwBxccvuPym/4fl39i5Lh8IpFIJBKJ9vEXEVe0/8vmeKoAAAAASUVORK5CYII=" alt="email" class="h-3"></span> <span><a href="mailto:weisong.teng.work@gmail.com?subject=Hi" class="hover:text-gray-800">Email</a></span></li></ul></div></div></footer></div></main></div></div><script defer src="/_nuxt/static/1663072908/notes/auth0-dotnet-6/state.js"></script><script src="/_nuxt/d235ded.js" defer></script><script src="/_nuxt/9e8d9e6.js" defer></script><script src="/_nuxt/c37e852.js" defer></script><script src="/_nuxt/028b3bc.js" defer></script><script src="/_nuxt/93a70bb.js" defer></script>
  </body>
</html>
